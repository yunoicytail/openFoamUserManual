# 67 数据归档

参数研究的过程中会生成大量数据。在后处理完成后，所有文件就可以压缩一下，以节省磁盘空间。在Linux系统中`tar`归档工具是首选。`tar`的命名很有描述性，来源于`tape archive`（译者注：分别取首字母`t`和`ar`）。一个`tar`归档就是一个单独的文件，其中包含了所有被归档的文件和文件夹。归档过程仅是数据的重组，适合于顺序数据存储设备（如磁带）的使用。

`tar`归档的第二步是压缩。这一步有许多选择。Linux系统通常提供了`gzip`、`bzip2`或`xz`等程序。之所以要把归档和压缩分开，可能是处于历史或者实际原因。也可能是遵循了UNIX哲学：让每个程序只做好一件事。压缩程序之间的差别在于压缩算法。有一条经验法则：要压缩的数据越多，压缩所需要的时间就越长。

表8列出了归档并压缩一个参数研究的结果，包含21个算例、共计50 GB数据。这些数据都是以ASCII格式写入的。压缩这些数据结果能节省70+%的磁盘空间。如果归档占用磁盘空间很大的算例，一般偏向于选择运行更耗时的算法，这样能得到更好的压缩率。

|                     | 占用磁盘空间 | 压缩            |
| ------------------- | ------------ | --------------- |
| 21个未压缩的算例    | 50 GB        | -               |
| 压缩后：`*.tar.bz2` | 13.7 GB      | 36.3 GB - 72.6% |

## 归档日志文件

这个例子展示日志文件的归档。这种情况下使用相同的算法节省了更多的磁盘空间。本例说明了归档压缩率与输入数据有很强的关系。

|                         | 占用磁盘空间 | 压缩            |
| ----------------------- | ------------ | --------------- |
| 16个未压缩的磁盘空i教案 | 2.0 GB       | -               |
| 压缩后: `*.tar.bz2`     | 154.7 MB     | 1.85 GB - 92.3% |



## 另一个压缩比较

<s>归档OpenFOAM算例的时候</s>在OpenFOAM前处理时（译者注：原文有误，意思不通），网格的生成可能非常复杂或耗时。因此一般会将网格与算例分开归档。这样，对于实际的算例，我们只需要直接解压之前归档的网格，而不需要困扰于网格创建。

这一节比较了Linux系统下3个压缩工具在压缩同一个网格时的表现。所采用的网格使用*blockMesh*命令创建，相关的文件使用二进制格式保存。

代码520展示了实际所使用的用于压缩网格的命令。

```sh
tar -cv polyMesh | gzip --best > polyMesh.tar.gz
tar -cv polyMesh | bzip2 --best > polyMesh.tar.bz
tar -cv polyMesh | lzma -9 > polyMesh.tar.xz
```

代码520: 用各种工具压缩网格；注意最大压缩设置。

```sh
user@host :∼$ du -sh polyMesh *
23M polyMesh
5,3M polyMesh.tar.bz
6,2M polyMesh.tar.gz
2,6M polyMesh.tar.xz
```

代码521: 比较原始网格及其不同压缩形式下磁盘的使用情况

代码521展示了原始以及压缩后的网格大小。所使用的压缩算法差异很大。各个工具都采用了最大压缩设置，这里没有记录每个工具的压缩耗时。但是压缩率越大，所需要的时间越多。由于是出于归档目的，磁盘空间是限制因素，因此我们往往会选择最大压缩率。

从代码521的比较中，我们可以看出`LZMA`压缩算法达到了最大压缩率，然后是`BZIP2`，最后是`GZIP`。这三种压缩算法都以开源实现的形式在UNIX世界中广泛使用。

## 网格重新编号和/或以二进制格式保存的影响

当使用不同的方式归档已有的网格时，可以观察到一些很有趣的现象：网格是否重新编号会影响归档文件的大小。注意这里只是归档网格，不考虑与之相关的求解数据（或场）。

表10中我们比较了一个全六面体、包含147262个单元的网格在归档之后文件的大小。网格本身所需要的磁盘空间只与存储格式有关，即ASCII或二进制格式。网格重新编号对网格的大小没有影响，这也很容易理解，因为重新编号并没有添加或删除信息。因此，网格所需的磁盘空间应该也不糊因为重新编号而改变。

然而，重新编号却对最终归档文件大小有一定影响（译者注：区别于前面的介绍，一般说的归档，应该指的是归档并压缩）。当网格以二进制格式写入磁盘时，压缩原始(as-is)网格只会产生微小的磁盘空间变化。但是最令人意外的是，当我们分别在两种情况下（ASCII和二进制）比较重新编号网格最终的归档文件大小，重新编号的网格压缩后的文件大小竟然比原始网格压缩后的文件还大。

| 网格     | ASCII | 二进制 |
| -------- | ----- | ------ |
| 原始     | 22 M  | 16 M   |
| 重新编号 | 22 M  | 16 M   |

| 归档     | ASCII | 二进制 |
| -------- | ----- | ------ |
| 原始     | 17 M  | 16 M   |
| 重新编号 | 25 M  | 20 M   |

Table 10: 比较不同条件/处理下网格归档文件的大小。这里所有的文件或文件夹的大小都使用Linux命令`du -sh FILE`确定。网格使用`LZMA`算法以最大压缩率压缩：`tar -cv constant/polyMesh | lzma -9 > polyMesh.tar.xz`。

从这组比较中可以得出两个结论。最明显的是，以二进制格式写入数据总是比以ASCII格式写入更好，对没有压缩的数据其占用磁盘大小的差异尤为明显。ASCII格式应该只在排查问题的时候选用。在实际作业中，应该选择二进制格式。以二进制格式写数据不仅能在存储上节省磁盘空间，也能提供最大读/写精度，因为每个数值的所有位都被保留了。相比之下，ASCII格式只是写入有限数量的有效位。（译者注：二进制读写速度也比ASCII快，计算时能节省写入数据的时间，后处理时能节省读取数据的时间）

从以上对比可以得出的第二个结论是：不要保存重新编号后的网格。即使重新编号不会增加归档文件的大小，它也是在模拟前很容易进行的操作。重新编号所需要的时间相比于总的模拟时间来说可以忽略。因此，建议在未重新编号的状态下归档网格。除了可以节省存储空间外，这还使将来的用户可以选择是否在重新编号的网格上进行模拟。对于已经重新编号的网格，无法确定网格重新编号在模拟时间和收敛性上有何优势。只需执行必要的操作进行计算模拟，不用归档该网格。

